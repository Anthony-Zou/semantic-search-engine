services:
  # MySQL Database
  mysql:
    image: mysql:8.0
    container_name: rag-mysql
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: rag_db
      MYSQL_USER: raguser
      MYSQL_PASSWORD: ragpassword
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis (for RAG vector embeddings/cache)
  redis:
    image: redis:7-alpine
    container_name: rag-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

  # Python Backend (FastAPI)
  backend:
    build: ./backend
    container_name: rag-backend
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
      - ./data:/data
    environment:
      - MYSQL_HOST=mysql
      - MYSQL_USER=raguser
      - MYSQL_PASSWORD=ragpassword
      - MYSQL_DATABASE=rag_db
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_started
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload

  # Jupyter for experimentation
  jupyter:
    image: jupyter/scipy-notebook:latest
    container_name: rag-jupyter
    ports:
      - "8888:8888"
    volumes:
      - ./notebooks:/home/jovyan/work
      - ./data:/home/jovyan/data
    environment:
      - JUPYTER_ENABLE_LAB=yes
    command: bash -c "pip install pymysql redis langchain openai chromadb && start-notebook.sh"

volumes:
  mysql_data:
  redis_data:
